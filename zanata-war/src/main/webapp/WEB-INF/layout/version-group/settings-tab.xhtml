<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:f="http://java.sun.com/jsf/core">

<script type="text/javascript">
  var newLanguageItems = "[id='#{rich:clientId('new--language')}Items']";
  var newVersionItems = "[id='#{rich:clientId('new--version')}Items']";
  var newMaintainerItems = "[id='#{rich:clientId('new--maintainer')}Items']";

  jQuery(document).ready(function () {
    jQuery('.js-tabs-nav').children('li').children('a').click(function () {
      var inputField = jQuery(jQuery(this).attr('href')).find('.js-tabs-nav-focus-input');
      if (inputField.length) {
        setTimeout(function () {
          focusInput(inputField);
          autocompleteResize(inputField);
        }, 50);
      }
    });

    setTimeout(function () {
      focusCurrentActiveInput();
      jQuery(jQuery('.js-tabs-nav').children('li.is-active').children('a').attr('href')).find('.js-tabs-nav-focus-input').each(function () {
        autocompleteResize(this);
      });
    }, 50);
  });

  function autocompleteResize(inputField) {
    var fieldId = jQuery(inputField).attr('id');
    fieldId = fieldId.substring(0,
      fieldId.length - "Input".length).concat("List").replace(/:/g, "\\:");

    jQuery('#' + fieldId).find(".rf-au-lst-scrl").css("width",
      jQuery(inputField).outerWidth() + "px");
  }

  function focusCurrentActiveInput() {
    jQuery(jQuery('.js-tabs-nav').children('li.is-active').children('a').attr('href')).find('.js-tabs-nav-focus-input').each(function () {
      focusInput(this);
    });
  }

  function focusInput(field) {
    jQuery(field).value = "";
    jQuery(field).focus();
  }

  function updateResultClickEvent(fieldSelector, clickFn) {
    jQuery(fieldSelector).find('.rf-au-itm').click(function () {
      clickFn(this.children[0].value);
    });
  }
</script>

<a4j:jsFunction name="addNewLanguage" render="settings-languages-form"
  oncomplete="refreshStatistics();focusCurrentActiveInput()"
  action="#{versionGroupHome.addLanguage()}">
  <a4j:param name="val" assignTo="#{versionGroupHome.newLanguage}"/>
</a4j:jsFunction>

<a4j:jsFunction name="addNewVersion" render="settings-projects-form"
  oncomplete="refreshStatistics();focusCurrentActiveInput()"
  action="#{versionGroupHome.addVersion()}">
  <a4j:param name="val" assignTo="#{versionGroupHome.newVersion}"/>
</a4j:jsFunction>

<a4j:jsFunction name="addNewMaintainer"
  render="settings-maintainers-form,pageMessages"
  oncomplete="focusCurrentActiveInput()"
  action="#{versionGroupHome.addMaintainer()}">
  <a4j:param name="val" assignTo="#{versionGroupHome.newMaintainer}"/>
</a4j:jsFunction>

<h1>#{messages['Settings']}</h1>

<div class="tabs--vertical js-tabs">
<ul class="tabs__nav js-tabs-nav">
  <li class="is-active">
    <a href="#settings-general" id="settings-general_tab"
      title="#{messages['General']}">
      <i class="i--left i--settings"></i>
      <span class="is-hidden--m-down">#{messages['jsf.General']}</span>
    </a>
  </li>
  <li>
    <a href="#settings-languages" id="settings-languages_tab"
      title="#{messages['Languages']}">
      <i class="i--left i--language"></i>
      <span class="is-hidden--m-down">#{messages['jsf.Languages']}</span>
    </a>
  </li>
  <li>
    <a href="#settings-projects" id="settings-projects_tab"
      title="#{messages['Projects']}">
      <i class="i--left i--project"></i>
      <span class="is-hidden--m-down">#{messages['jsf.Projects']}</span>
    </a>
  </li>
  <li>
    <a href="#settings-maintainers" id="settings-maintainers_tab"
      title="#{messages['Maintainers']}">
      <i class="i--left i--users"></i>
      <span class="is-hidden--m-down">#{messages['jsf.Maintainers']}</span>
    </a>
  </li>
</ul>
<ul class="tabs__content js-tabs-content">
<li class="is-active" id="settings-general">
  <h2 class="l--push-all-0 gamma d--bottom">
    #{messages['jsf.General']}
  </h2>
  <h:form styleClass="l--push-bottom-0">
    <div class="l--constrain-medium">
      <ui:include src="edit_form.xhtml"/>

      <div class="l--push-top-1">
        <a4j:commandLink value="#{messages['jsf.UpdateGeneralSettings']}"
          action="#{versionGroupHome.update}"
          rendered="#{versionGroupHome.managed}"
          render="group-info,pageMessages"
          styleClass="l--push-right-half button--primary"/>
      </div>
      <hr/>
      <a4j:outputPanel id="status">
        <s:fragment
          rendered="#{versionGroupHome.instance.status == 'ACTIVE'}">
          <p>
            <a4j:commandLink styleClass="button--danger"
              action="#{versionGroupHome.setStatus('O')}" render="status">
              #{messages['jsf.ArchiveThisGroup']}
            </a4j:commandLink>
          </p>

          <p class="txt--meta">
            #{messages['jsf.ArchiveGroupMessage']}
          </p>
        </s:fragment>

        <s:fragment
          rendered="#{versionGroupHome.instance.status != 'ACTIVE'}">
          <p>
            <a4j:commandLink styleClass="button--success"
              action="#{versionGroupHome.setStatus('A')}" render="status">
              #{messages['jsf.ActivateThisGroup']}
            </a4j:commandLink>
          </p>

          <p class="txt--meta">
            #{messages['jsf.ActivateGroupMessage']}
          </p>
        </s:fragment>

      </a4j:outputPanel>
    </div>
  </h:form>
</li>
<li id="settings-languages">
  <h2 class="l--push-all-0 gamma d--bottom l--push-bottom-half">
    #{messages['jsf.Languages']}
  </h2>
  <h:form id="settings-languages-form" styleClass="l--push-bottom-0">
    <ul class="list--slat list--highlight l--push-top-half">
      <ui:repeat value="#{versionGroupHome.getInstanceActiveLocales()}"
        var="locale">
        <li class="reveal">#{locale.retrieveDisplayName()}<span
          class="txt--understated l--push-left-quarter">[#{locale.localeId}]</span>
          <a4j:commandLink oncomplete="refreshStatistics()" execute="@this"
            action="#{versionGroupHome.removeLanguage(locale)}"
            styleClass="l--float-right txt--danger reveal__target"
            render="settings-languages-form">
            <i class="i--large i--remove"></i>
          </a4j:commandLink>
        </li>
      </ui:repeat>
      <li>
        <label for="#{rich:clientId('new--language')}Input">
          #{messages['jsf.AddALanguage']}
        </label>

        <rich:autocomplete mode="cachedAjax" var="suggestLocale"
          styleClass="auto-complete" id="new--language"
          inputClass="autocomplete__input js-tabs-nav-focus-input"
          onselectitem="addNewLanguage(this.value);"
          autocompleteMethod="#{versionGroupHome.suggestLocales}"
          layout="list"
          oncomplete="updateResultClickEvent(newLanguageItems, addNewLanguage)"
          fetchValue="#{suggestLocale.retrieveDisplayName()} [#{suggestLocale.localeId}]"
          popupClass="auto-complete-list" minChars="0">
          <rich:placeholder value="#{messages['jsf.AddALanguage']}"
            styleClass="form__placeholder"/>

          <h:inputHidden
            value="#{suggestLocale.retrieveDisplayName()} [#{suggestLocale.localeId}]"/>
          #{suggestLocale.retrieveDisplayName()}<span
          class="txt--understated l--push-left-quarter">[#{suggestLocale.localeId}]</span>
        </rich:autocomplete>
      </li>
    </ul>
  </h:form>
</li>
<li id="settings-projects">
  <h2 class="l--push-all-0 gamma d--bottom l--push-bottom-half">
    #{messages['jsf.Projects']}
  </h2>
  <h:form id="settings-projects-form" styleClass="l--push-bottom-0">
    <ul class="list--slat l--push-top-half">
      <ui:repeat
        value="#{versionGroupHome.getSortedInstanceProjectIterations()}"
        var="version">
        <li class="reveal">
          <s:link view="/iteration/view.xhtml">
            <f:param name="projectSlug" value="#{version.project.slug}"/>
            <f:param name="iterationSlug" value="#{version.slug}"/>
            #{version.project.name} <i class="i i--version"></i> #{version.slug}
          </s:link>
          <a4j:commandLink
            action="#{versionGroupHome.removeVersion(version)}"
            oncomplete="refreshStatistics()"
            styleClass="l--float-right txt--danger reveal__target"
            render="settings-projects-form">
            <i class="i--large i--remove"></i>
          </a4j:commandLink>
        </li>
      </ui:repeat>
      <li>
        <label for="#{rich:clientId('newVersion')}Input">
          #{messages['jsf.AddAProject']}
        </label>

        <rich:autocomplete mode="cachedAjax" var="suggestVersion"
          minChars="3"
          styleClass="auto-complete" id="new--version"
          inputClass="autocomplete__input js-tabs-nav-focus-input"
          onselectitem="addNewVersion(this.value);"
          popupClass="auto-complete-list"
          autocompleteMethod="#{versionGroupHome.suggestVersions}"
          layout="list"
          oncomplete="updateResultClickEvent(newVersionItems, addNewVersion)"
          fetchValue="#{suggestVersion.project.slug} #{suggestVersion.slug}">
          <rich:placeholder value="#{messages['jsf.AddAProject']}"
            styleClass="form__placeholder"/>

          <h:inputHidden
            value="#{suggestVersion.project.slug} #{suggestVersion.slug}"/>
          #{suggestVersion.project.slug} <i
          class="i i--version"></i> #{suggestVersion.slug}
        </rich:autocomplete>
      </li>
    </ul>
  </h:form>
</li>
<li id="settings-maintainers">
  <h2 class="l--push-all-0 gamma d--bottom l--push-bottom-half">
    #{messages['jsf.Maintainers']}
  </h2>
  <h:form id="settings-maintainers-form" styleClass="l--push-bottom-0">
    <ul class="list--slat l--push-top-half">
      <ui:repeat value="#{versionGroupHome.getInstanceMaintainers()}"
        var="maintainer">
        <li class="reveal--list-item">
          <span class="w--r-1 bx--round l--push-right-quarter">
            <img
              src="#{gravatarServiceImpl.getUserImageUrl(48, maintainer.email)}"
              alt="#{maintainer.account.username}"/>
          </span> #{maintainer.name}
          <span class="txt--meta">@#{maintainer.account.username}</span>
          <a4j:commandLink
            action="#{versionGroupHome.removeMaintainer(maintainer)}"
            styleClass="l--float-right txt--danger reveal__target"
            render="settings-maintainers-form,maintainers-size,maintainers-list,maintainers_content">
            <i class="i--large i--remove"></i>
          </a4j:commandLink>
        </li>
      </ui:repeat>

      <li>
        <label for="#{rich:clientId('newMaintainer')}Input">
          #{messages['jsf.AddAMaintainer']}
        </label>

        <rich:autocomplete mode="cachedAjax" var="suggestMaintainer"
          minChars="3"
          styleClass="auto-complete" id="new--maintainer"
          inputClass="autocomplete__input js-tabs-nav-focus-input"
          onselectitem="addNewMaintainer(this.value);"
          popupClass="auto-complete-list"
          autocompleteMethod="#{versionGroupHome.suggestMaintainers}"
          layout="list"
          oncomplete="updateResultClickEvent(newMaintainerItems, addNewMaintainer)"
          fetchValue="#{suggestMaintainer.name} @#{suggestMaintainer.account.username}">
          <rich:placeholder value="#{messages['jsf.AddAMaintainer']}"
            styleClass="form__placeholder"/>

          <h:inputHidden
            value="#{suggestMaintainer.name} @#{suggestMaintainer.account.username}"/>
            <span class="w--r-1 bx--round l--push-right-quarter">
                <img
                  src="#{gravatarServiceImpl.getUserImageUrl(48, suggestMaintainer.email)}"
                  alt="#{suggestMaintainer.name}"/>
              </span>#{suggestMaintainer.name}
            <span
              class="txt--meta">@#{suggestMaintainer.account.username}</span>
        </rich:autocomplete>
      </li>
    </ul>
  </h:form>
</li>
</ul>
</div>
</ui:composition>
