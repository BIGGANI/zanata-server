<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog 
   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" 
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
                  http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <!--
    This changelog file is the real changelog for Zanata 1.6.
     -->
	<changeSet author="camunoz@redhat.com" id="1">
		<comment>Add HTextFlowContent table to support plural forms.</comment>
		<createTable tableName="HTextFlowContent">
			<column name="id" type="bigint" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="content" type="longtext">
				<constraints nullable="false"/>
			</column>
			<column name="pos" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="text_flow_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint constraintName="FKcontent_text_flow" 
			referencedTableName="HTextFlow" referencedColumnNames="id"
			baseTableName="HTextFlowContent" baseColumnNames="text_flow_id"/>
	</changeSet>
	
	<changeSet author="camunoz@redhat.com" id="2">
		<comment>Add HTextFlowContentHistory table to support plural forms.</comment>
		<createTable tableName="HTextFlowContentHistory">
			<column name="id" type="bigint" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="content" type="longtext">
				<constraints nullable="false"/>
			</column>
			<column name="pos" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="text_flow_history_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint constraintName="FKcontent_text_flow_history" 
			referencedTableName="HTextFlowHistory" referencedColumnNames="id"
			baseTableName="HTextFlowContentHistory" baseColumnNames="text_flow_history_id"/>
	</changeSet>
	
	<changeSet author="camunoz@redhat.com" id="3">
		<comment>Replace content columns from HTextFlow into the new HTextFlowContent table</comment>
		<sql>
			insert into HTextFlowContent(content, pos, text_flow_id) 
			select content, 0, id from HTextFlow
		</sql>
		<sql>
			insert into HTextFlowContentHistory(content, pos, text_flow_history_id) 
			select content, 0, id from HTextFlowHistory
		</sql>
	</changeSet>
	
	<changeSet author="camunoz@redhat.com" id="4">
		<comment>Add HTextFlowTargetContent table to support plural forms.</comment>
		<createTable tableName="HTextFlowTargetContent">
			<column name="id" type="bigint" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="content" type="longtext">
				<constraints nullable="false"/>
			</column>
			<column name="pos" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="text_flow_target_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint constraintName="FKcontent_text_flow_target" 
			referencedTableName="HTextFlowTarget" referencedColumnNames="id"
			baseTableName="HTextFlowTargetContent" baseColumnNames="text_flow_target_id"/>
	</changeSet>
	
	<changeSet author="camunoz@redhat.com" id="5">
		<comment>Add HTextFlowTargetContentHistory table to support plural forms.</comment>
		<createTable tableName="HTextFlowTargetContentHistory">
			<column name="id" type="bigint" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="content" type="longtext">
				<constraints nullable="false"/>
			</column>
			<column name="pos" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="text_flow_target_history_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint constraintName="FKcontent_text_flow_target_history" 
			referencedTableName="HTextFlowTargetHistory" referencedColumnNames="id"
			baseTableName="HTextFlowTargetContentHistory" baseColumnNames="text_flow_target_history_id"/>
	</changeSet>
	
	<changeSet author="camunoz@redhat.com" id="6">
		<comment>Replace content columns from HTextFlowTarget into the new HTextFlowTargetContent table</comment>
		<sql>
			insert into HTextFlowTargetContent(content, pos, text_flow_target_id) 
			select content, 0, id from HTextFlowTarget
		</sql>
		<sql>
			insert into HTextFlowTargetContentHistory(content, pos, text_flow_target_history_id) 
			select content, 0, id from HTextFlowTargetHistory
		</sql>
	</changeSet>
	
	<changeSet author="camunoz@redhat.com" id="7">
		<comment>Remove unnecessary columns</comment>
		<dropColumn tableName="HTextFlow" columnName="content"/>
		<dropColumn tableName="HTextFlowHistory" columnName="content"/>
		<dropColumn tableName="HTextFlowTarget" columnName="content"/>
		<dropColumn tableName="HTextFlowTargetHistory" columnName="content"/>
		<addColumn tableName="HTextFlow">
            <column name="plural" type="boolean" valueBoolean="false"/>
        </addColumn>
	</changeSet>

</databaseChangeLog>
